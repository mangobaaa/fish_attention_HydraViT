{"cells":[{"cell_type":"code","execution_count":1,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":2364,"status":"ok","timestamp":1767023115859,"user":{"displayName":"박예진","userId":"12026995828990149275"},"user_tz":-540},"id":"3bGbPXWH_z4L","outputId":"00e0a624-ca01-4981-af95-6441d1ad3074"},"outputs":[{"output_type":"stream","name":"stdout","text":["Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(\"/content/drive\", force_remount=True).\n"]}],"source":["from google.colab import drive\n","drive.mount('/content/drive')"]},{"cell_type":"code","execution_count":2,"metadata":{"executionInfo":{"elapsed":9,"status":"ok","timestamp":1767023115874,"user":{"displayName":"박예진","userId":"12026995828990149275"},"user_tz":-540},"id":"CKS-Rtzpfh2u"},"outputs":[],"source":["import sys\n","\n","PROJECT_ROOT = \"/content/drive/MyDrive/fish_attention_HydraViT_test\"\n","sys.path.insert(0, PROJECT_ROOT)\n","\n","# pip timm 캐시 완전 제거\n","for k in list(sys.modules.keys()):\n","    if k == \"timm\" or k.startswith(\"timm.\"):\n","        del sys.modules[k]\n"]},{"cell_type":"code","execution_count":3,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":9762,"status":"ok","timestamp":1767023125640,"user":{"displayName":"박예진","userId":"12026995828990149275"},"user_tz":-540},"id":"C-j78np1iH_F","outputId":"0dffdcae-7a95-4ad7-8fa0-f5319cb0e3c7"},"outputs":[{"output_type":"stream","name":"stdout","text":["timm module path: /content/drive/MyDrive/fish_attention_HydraViT_test/timm/__init__.py\n","timm package paths: ['/content/drive/MyDrive/fish_attention_HydraViT_test/timm']\n"]}],"source":["import timm\n","print(\"timm module path:\", getattr(timm, \"__file__\", None))\n","print(\"timm package paths:\", list(getattr(timm, \"__path__\", [])))\n"]},{"cell_type":"code","execution_count":4,"metadata":{"executionInfo":{"elapsed":11686,"status":"ok","timestamp":1767023137322,"user":{"displayName":"박예진","userId":"12026995828990149275"},"user_tz":-540},"id":"uXDZgSs3GuCT"},"outputs":[],"source":["from timm.models.hydravit import HydraViT, Block, FiSHBlock"]},{"cell_type":"code","execution_count":5,"metadata":{"executionInfo":{"elapsed":5,"status":"ok","timestamp":1767023137330,"user":{"displayName":"박예진","userId":"12026995828990149275"},"user_tz":-540},"id":"2jBeAJ5brm24"},"outputs":[],"source":["import torch\n","import torchvision\n","import torchvision.transforms as T\n","from torch.utils.data import DataLoader\n","\n","from timm.data import IMAGENET_INCEPTION_MEAN, IMAGENET_INCEPTION_STD\n","\n","def get_dataloaders(data_dir: str, batch_size: int, num_workers: int):\n","    transform_train = T.Compose([\n","        T.Resize(256),\n","        T.RandomResizedCrop(224),\n","        T.RandomHorizontalFlip(),\n","        T.ToTensor(),\n","        T.Normalize(IMAGENET_INCEPTION_MEAN, IMAGENET_INCEPTION_STD),\n","    ])\n","\n","    transform_test = T.Compose([\n","        T.Resize(256),\n","        T.CenterCrop(224),\n","        T.ToTensor(),\n","        T.Normalize(IMAGENET_INCEPTION_MEAN, IMAGENET_INCEPTION_STD),\n","    ])\n","\n","    train_set = torchvision.datasets.CIFAR10(\n","        root=data_dir,\n","        train=True,\n","        download=True,\n","        transform=transform_train,\n","    )\n","    test_set = torchvision.datasets.CIFAR10(\n","        root=data_dir,\n","        train=False,\n","        download=True,\n","        transform=transform_test,\n","    )\n","\n","    train_loader = DataLoader(train_set, batch_size=batch_size, shuffle=True, num_workers=num_workers)\n","    test_loader = DataLoader(test_set, batch_size=batch_size, shuffle=False, num_workers=num_workers)\n","\n","    return train_loader, test_loader\n"]},{"cell_type":"code","execution_count":6,"metadata":{"executionInfo":{"elapsed":12,"status":"ok","timestamp":1767023137346,"user":{"displayName":"박예진","userId":"12026995828990149275"},"user_tz":-540},"id":"HuII-JT__I_S"},"outputs":[],"source":["import torch\n","import torch.nn as nn\n","import torch.optim as optim\n","from tqdm import tqdm\n","\n","device = \"cuda\" if torch.cuda.is_available() else \"cpu\"\n","\n","NUM_CLASSES = 10\n","\n","def create_baseline_hydravit(\n","    num_classes: int = NUM_CLASSES,\n","    dim: int = 384,\n","    depth: int = 8,\n","    num_heads: int = 6,\n","):\n","    model = HydraViT(\n","        img_size=224,\n","        patch_size=16,\n","        in_chans=3,\n","        num_classes=num_classes,\n","        embed_dim=dim,\n","        depth=depth,\n","        num_heads=num_heads,\n","        block_fn=Block,\n","    )\n","    return model.to(device)\n","\n","\n","def create_fish_hydravit(\n","    num_classes: int = NUM_CLASSES,\n","    dim: int = 384,\n","    depth: int = 8,\n","    num_heads: int = 6,\n","):\n","    model = HydraViT(\n","        img_size=224,\n","        patch_size=16,\n","        in_chans=3,\n","        num_classes=num_classes,\n","        embed_dim=dim,\n","        depth=depth,\n","        num_heads=num_heads,\n","        block_fn=FiSHBlock,\n","    )\n","    return model.to(device)\n"]},{"cell_type":"code","execution_count":7,"metadata":{"id":"9cPdms7s_IoL","executionInfo":{"status":"error","timestamp":1767023251246,"user_tz":-540,"elapsed":113897,"user":{"displayName":"박예진","userId":"12026995828990149275"}},"colab":{"base_uri":"https://localhost:8080/","height":469},"outputId":"e0c1ac06-5dc8-4a14-b1b0-75de40685b76"},"outputs":[{"output_type":"stream","name":"stdout","text":["=== Training Baseline HydraViT ===\n"]},{"output_type":"stream","name":"stderr","text":["  0%|          | 3/782 [01:51<8:01:42, 37.10s/it]\n"]},{"output_type":"error","ename":"KeyboardInterrupt","evalue":"","traceback":["\u001b[0;31m---------------------------------------------------------------------------\u001b[0m","\u001b[0;31mKeyboardInterrupt\u001b[0m                         Traceback (most recent call last)","\u001b[0;32m/tmp/ipython-input-835917804.py\u001b[0m in \u001b[0;36m<cell line: 0>\u001b[0;34m()\u001b[0m\n\u001b[1;32m     54\u001b[0m \u001b[0mprint\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m\"=== Training Baseline HydraViT ===\"\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     55\u001b[0m \u001b[0;32mfor\u001b[0m \u001b[0mepoch\u001b[0m \u001b[0;32min\u001b[0m \u001b[0mrange\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mEPOCHS\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 56\u001b[0;31m    \u001b[0macc\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mtrain_one_epoch\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mbaseline_model\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mtrain_loader\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcriterion\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0moptimizer_baseline\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     57\u001b[0m    \u001b[0mprint\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34mf\"[Baseline] Epoch {epoch+1}: Train Acc = {acc:.4f}\"\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     58\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/tmp/ipython-input-835917804.py\u001b[0m in \u001b[0;36mtrain_one_epoch\u001b[0;34m(model, loader, criterion, optimizer)\u001b[0m\n\u001b[1;32m     26\u001b[0m         \u001b[0moutputs\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mmodel\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mimgs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     27\u001b[0m         \u001b[0mloss\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0mcriterion\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0moutputs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mlabels\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m---> 28\u001b[0;31m         \u001b[0mloss\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mbackward\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0m\u001b[1;32m     29\u001b[0m         \u001b[0moptimizer\u001b[0m\u001b[0;34m.\u001b[0m\u001b[0mstep\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m     30\u001b[0m \u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.12/dist-packages/torch/_tensor.py\u001b[0m in \u001b[0;36mbackward\u001b[0;34m(self, gradient, retain_graph, create_graph, inputs)\u001b[0m\n\u001b[1;32m    623\u001b[0m                 \u001b[0minputs\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0minputs\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    624\u001b[0m             )\n\u001b[0;32m--> 625\u001b[0;31m         torch.autograd.backward(\n\u001b[0m\u001b[1;32m    626\u001b[0m             \u001b[0mself\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mgradient\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mretain_graph\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0mcreate_graph\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0minputs\u001b[0m\u001b[0;34m=\u001b[0m\u001b[0minputs\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    627\u001b[0m         )\n","\u001b[0;32m/usr/local/lib/python3.12/dist-packages/torch/autograd/__init__.py\u001b[0m in \u001b[0;36mbackward\u001b[0;34m(tensors, grad_tensors, retain_graph, create_graph, grad_variables, inputs)\u001b[0m\n\u001b[1;32m    352\u001b[0m     \u001b[0;31m# some Python versions print out the first line of a multi-line function\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    353\u001b[0m     \u001b[0;31m# calls in the traceback and some print out the last line\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 354\u001b[0;31m     _engine_run_backward(\n\u001b[0m\u001b[1;32m    355\u001b[0m         \u001b[0mtensors\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    356\u001b[0m         \u001b[0mgrad_tensors_\u001b[0m\u001b[0;34m,\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n","\u001b[0;32m/usr/local/lib/python3.12/dist-packages/torch/autograd/graph.py\u001b[0m in \u001b[0;36m_engine_run_backward\u001b[0;34m(t_outputs, *args, **kwargs)\u001b[0m\n\u001b[1;32m    839\u001b[0m         \u001b[0munregister_hooks\u001b[0m \u001b[0;34m=\u001b[0m \u001b[0m_register_logging_hooks_on_whole_graph\u001b[0m\u001b[0;34m(\u001b[0m\u001b[0mt_outputs\u001b[0m\u001b[0;34m)\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    840\u001b[0m     \u001b[0;32mtry\u001b[0m\u001b[0;34m:\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[0;32m--> 841\u001b[0;31m         return Variable._execution_engine.run_backward(  # Calls into the C++ engine to run the backward pass\n\u001b[0m\u001b[1;32m    842\u001b[0m             \u001b[0mt_outputs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m*\u001b[0m\u001b[0margs\u001b[0m\u001b[0;34m,\u001b[0m \u001b[0;34m**\u001b[0m\u001b[0mkwargs\u001b[0m\u001b[0;34m\u001b[0m\u001b[0;34m\u001b[0m\u001b[0m\n\u001b[1;32m    843\u001b[0m         )  # Calls into the C++ engine to run the backward pass\n","\u001b[0;31mKeyboardInterrupt\u001b[0m: "]}],"source":["train_loader, test_loader = get_dataloaders(\n","    data_dir=\"/content/data\",\n","    batch_size=64,\n","    num_workers=2,\n",")\n","\n","criterion = nn.CrossEntropyLoss()\n","\n","#  Baseline HydraViT\n","baseline_model = create_baseline_hydravit()\n","optimizer_baseline = optim.AdamW(baseline_model.parameters(), lr=3e-4)\n","\n","# FiSH-HydraViT\n","fish_model = create_fish_hydravit()\n","optimizer_fish = optim.AdamW(fish_model.parameters(), lr=3e-4)\n","\n","\n","def train_one_epoch(model, loader, criterion, optimizer):\n","    model.train()\n","    total = 0\n","    correct = 0\n","    for imgs, labels in tqdm(loader):\n","        imgs, labels = imgs.to(device), labels.to(device)\n","\n","        optimizer.zero_grad()\n","        outputs = model(imgs)\n","        loss = criterion(outputs, labels)\n","        loss.backward()\n","        optimizer.step()\n","\n","        _, pred = outputs.max(1)\n","        correct += pred.eq(labels).sum().item()\n","        total += labels.size(0)\n","\n","    return correct / total\n","\n","\n","def evaluate(model, loader):\n","    model.eval()\n","    total = 0\n","    correct = 0\n","    with torch.no_grad():\n","        for imgs, labels in loader:\n","            imgs, labels = imgs.to(device), labels.to(device)\n","            outputs = model(imgs)\n","            _, pred = outputs.max(1)\n","            correct += pred.eq(labels).sum().item()\n","            total += labels.size(0)\n","    return correct / total\n","\n","\n","EPOCHS = 3\n","\n","print(\"=== Training Baseline HydraViT ===\")\n","for epoch in range(EPOCHS):\n","   acc = train_one_epoch(baseline_model, train_loader, criterion, optimizer_baseline)\n","   print(f\"[Baseline] Epoch {epoch+1}: Train Acc = {acc:.4f}\")\n","\n","baseline_test_acc = evaluate(baseline_model, test_loader)\n","print(f\"[Baseline] Test Acc = {baseline_test_acc:.4f}\")\n","\n","print(\"\\n=== Training FiSH-HydraViT ===\")\n","for epoch in range(EPOCHS):\n","    acc = train_one_epoch(fish_model, train_loader, criterion, optimizer_fish)\n","    print(f\"[FiSH] Epoch {epoch+1}: Train Acc = {acc:.4f}\")\n","\n","fish_test_acc = evaluate(fish_model, test_loader)\n","print(f\"[FiSH] Test Acc = {fish_test_acc:.4f}\")\n"]}],"metadata":{"colab":{"provenance":[],"authorship_tag":"ABX9TyMyPYomrHl4f4H2OKsbDAXr"},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}